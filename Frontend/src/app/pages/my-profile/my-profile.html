<app-main-header></app-main-header>

<div class="profile-container" *ngIf="!loading(); else loadingTpl">
  <div class="profile-header">
    <h1>Edit Profile</h1>
  </div>

  <div class="profile-form">
    <!-- Messages -->
    <div *ngIf="error()" class="message error">{{ error() }}</div>
    <div *ngIf="success()" class="message success">{{ success() }}</div>

    <!-- Avatar -->
    <div class="avatar-section">
      <img [src]="avatarUrl() || 'assets/default-avatar.png'" alt="Avatar" class="avatar-preview">
      <input type="file" (change)="onFileSelected($event)" accept="image/*" class="file-input">
    </div>

    <!-- Read-only Fields -->
    <div class="form-group">
      <label>Username</label>
      <div class="read-only-field">{{ profile()?.username }}</div>
      <small class="field-note">Username cannot be changed</small>
    </div>

    <div class="form-group">
      <label>Age</label>
      <div class="read-only-field">{{ profile()?.age || 'Not set' }}</div>
      <small class="field-note">Age cannot be changed</small>
    </div>

    <!-- Editable Fields -->
    <div class="form-group">
      <label for="email">Email</label>
      <input type="email" id="email" [ngModel]="email()" (ngModelChange)="email.set($event)" class="form-control"
        placeholder="Email">
      <div *ngIf="emailError()" class="error">{{ emailError() }}</div>
    </div>

    <div class="form-group">
      <label for="password">New Password (leave blank to keep current)</label>
      <input type="password" id="password" [ngModel]="password()" (ngModelChange)="password.set($event)"
        class="form-control" placeholder="New Password">
      <div *ngIf="passwordError()" class="error">{{ passwordError() }}</div>
    </div>

    <div class="actions">
      <button class="save-btn" (click)="save()" [disabled]="emailError() || passwordError()">Save Changes</button>
    </div>
  </div>
</div>

<ng-template #loadingTpl>
  <div class="loading">Loading profile...</div>
</ng-template>

<div class="my-posts" *ngIf="!postsLoading()">
  <h2>My Posts</h2>
  <div *ngIf="posts().length === 0" class="no-posts">You haven't posted anything yet.</div>
  <div class="posts-list">
    <app-post-card *ngFor="let p of posts()" [post]="p" (openComments)="openComments($event)"></app-post-card>
  </div>
</div>

<div *ngIf="postsLoading()" class="loading">Loading your posts...</div>

<app-comments-section [postId]="activePostId" [visible]="commentsOpen" (close)="closeComments()"></app-comments-section>